<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyPocket - AI Web Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #ee5a24;
            --secondary-color: #667eea;
            --background: #f8f9fa;
            --surface: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border: #e9ecef;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.15);
            --sidebar-width: 280px;
        }

        /* Enhanced Dark mode with better contrast */
        [data-theme="dark"] {
            --primary-color: #ff6b35;
            --secondary-color: #7b88f7;
            --background: #0d1117;
            --surface: #161b22;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --border: #30363d;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.6);
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.8);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--background);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        /* FIXED: Proper Vertical Sidebar Navigation */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            border-right: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            flex-shrink: 0;
        }

        .sidebar-logo {
            font-size: 1.4em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .connection-status {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .sidebar-nav {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-section-title {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin: 0 20px 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--background);
            border-left-color: var(--primary-color);
        }

        .nav-item.active {
            background: var(--background);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }

        .nav-item .icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .nav-item .label {
            flex: 1;
        }

        .nav-item .badge {
            background: var(--primary-color);
            color: white;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 16px;
            text-align: center;
        }

        /* FIXED: Main Content Area with proper margin */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }

        /* Header */
        .header {
            background: var(--surface);
            color: var(--text-primary);
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
            transform: translateY(-1px);
        }

        /* Search Toggle Animation */
        .search-container {
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 90;
            padding: 30px 0;
        }

        .search-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .search-container.hidden {
            opacity: 0;
            transform: translateY(-10px);
        }

        /* Category Filter Styles */
        .category-container {
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 89;
            padding: 20px 0;
        }

        .category-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .category-container.hidden {
            opacity: 0;
            transform: translateY(-10px);
        }

        .category-filter {
            max-width: 800px;
            margin: 0 auto;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.2em;
        }

        .category-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .category-close-btn:hover {
            background: var(--border);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .category-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .category-chip {
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .category-chip:hover {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .category-chip.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .category-chip.show-all {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
            font-weight: 600;
        }

        .category-chip.show-all:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .category-count {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .category-chip:not(.active) .category-count {
            background: var(--border);
            color: var(--text-secondary);
        }

        .search-box {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid var(--border);
            border-radius: 25px;
            font-size: 16px;
            background: var(--background);
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-close-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .search-close-btn:hover {
            background: var(--border);
            color: var(--text-primary);
            transform: translateY(-50%) scale(1.1);
        }

        /* Status */
        .status {
            padding: 20px 0;
            text-align: center;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .status.loading {
            color: var(--secondary-color);
        }

        .status.error {
            color: #e74c3c;
        }

        .status.success {
            color: #27ae60;
        }

        /* Articles Grid - SMALLER TILES */
        .articles-section {
            padding: 40px 0;
            min-height: 60vh;
            flex: 1;
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 18px;
            margin-top: 20px;
        }

        /* ORGANIC SHAPED TILES - SMALLER VERSION */
        .article-card {
            background: var(--surface);
            border-radius: 32px 24px 32px 24px;
            overflow: visible;
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid var(--border);
            position: relative;
            display: flex;
            flex-direction: column;
            transform-origin: center center;
        }

        /* Varying organic shapes for visual interest */
        .article-card:nth-child(3n+1) {
            border-radius: 28px 36px 28px 36px;
        }

        .article-card:nth-child(3n+2) {
            border-radius: 35px 25px 35px 25px;
        }

        .article-card:nth-child(3n+3) {
            border-radius: 30px 30px 40px 20px;
        }

        .article-card:nth-child(4n+1) {
            border-radius: 40px 20px 30px 30px;
        }

        .article-card:nth-child(5n+1) {
            border-radius: 25px 35px 25px 35px;
        }

        .article-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-8px) scale(1.02) rotate(1deg);
            border-color: var(--primary-color);
        }

        .article-card:nth-child(even):hover {
            transform: translateY(-8px) scale(1.02) rotate(-1deg);
        }

        .article-card:hover .article-actions {
            opacity: 1 !important;
        }

        /* Organic shaped image area */
        .article-image {
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            position: relative;
            overflow: hidden;
            border-radius: inherit;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        }

        .article-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease, opacity 0.3s ease;
        }

        .article-image:hover img {
            transform: scale(1.08);
        }

        /* Compact content area with organic feel */
        .article-content {
            padding: 15px;
            flex: 1;
            cursor: pointer;
            border-radius: 0 0 inherit inherit;
        }

        .article-title {
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 6px;
            line-height: 1.3;
            color: var(--text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-excerpt {
            color: var(--text-secondary);
            font-size: 0.8em;
            line-height: 1.4;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 0.75em;
            margin-bottom: 6px;
        }

        .article-domain {
            font-weight: 500;
        }

        .article-date {
            opacity: 0.8;
        }

        .article-stats {
            display: flex;
            gap: 10px;
            font-size: 0.7em;
            color: var(--text-secondary);
        }

        /* Enhanced category badge */
        .article-category {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.7em;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .article-category.high-confidence {
            background: rgba(39, 174, 96, 0.1);
            border-color: #27ae60;
            color: #27ae60;
        }

        .article-category.medium-confidence {
            background: rgba(255, 193, 7, 0.1);
            border-color: #ffc107;
            color: #e6a000;
        }

        .article-category.low-confidence {
            background: rgba(108, 117, 125, 0.1);
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }

        /* Floating organic action buttons */
        .article-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            opacity: 0 !important;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 10;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--border);
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-4px) scale(1.15);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            border-radius: 40% 60% 70% 30%;
        }

        .read-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            border-radius: 60% 40% 30% 70%;
        }

        .export-btn:hover {
            background: #e8f5e8;
            border-color: #4caf50;
            border-radius: 30% 70% 60% 40%;
        }

        .refresh-image-btn:hover {
            background: #fff3e0;
            border-color: #ff9800;
            border-radius: 40% 60% 40% 60%;
        }

        .delete-btn {
            color: #f44336;
        }

        .delete-btn:hover {
            background: #ffebee;
            border-color: #f44336;
            color: #d32f2f;
            border-radius: 70% 30% 40% 60%;
        }

        .article-card:hover .article-actions {
            opacity: 1 !important;
            visibility: visible !important;
        }

        body.test-mode .article-actions {
            opacity: 1 !important;
            visibility: visible !important;
            background: rgba(255, 255, 0, 0.1);
            border: 2px dashed #ff9800;
            border-radius: 20px;
            padding: 5px;
        }

        .article-actions:hover {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Reader View */
        .reader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            overflow-y: auto;
        }

        .reader-overlay.active {
            display: block;
        }

        .reader-container {
            max-width: 800px;
            margin: 40px auto;
            background: var(--surface);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3);
        }

        .reader-header {
            padding: 30px;
            border-bottom: 1px solid var(--border);
            background: var(--background);
        }

        .reader-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .reader-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .reader-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .reader-content {
            padding: 40px;
            font-size: 1.1em;
            line-height: 1.8;
            max-width: none;
        }

        .reader-content h1,
        .reader-content h2,
        .reader-content h3 {
            margin: 30px 0 15px;
            color: var(--text-primary);
        }

        .reader-content p {
            margin-bottom: 20px;
        }

        .reader-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 20px 0;
        }

        .reader-content blockquote {
            border-left: 4px solid var(--primary-color);
            margin: 20px 0;
            padding: 15px 20px;
            background: var(--background);
            font-style: italic;
        }

        .close-reader {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-reader:hover {
            border-radius: 30% 70% 70% 30%;
            transform: scale(1.1);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Cache indicator */
        .cache-indicator {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            z-index: 5;
        }

        .cache-indicator.cached {
            background: rgba(39, 174, 96, 0.8);
        }

        .cache-indicator.fresh {
            background: rgba(52, 152, 219, 0.8);
        }

        .cache-indicator.synced {
            background: rgba(76, 175, 80, 0.8);
            color: white;
        }

        .cache-indicator.fallback {
            background: rgba(255, 152, 0, 0.8);
            color: white;
        }

        .cache-indicator.metadata {
            background: rgba(103, 58, 183, 0.8);
            color: white;
        }

        .cache-indicator.error {
            background: rgba(244, 67, 54, 0.8);
            color: white;
        }

        /* Enhanced Mobile Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 200;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block !important;
            }

            .container {
                padding: 0 12px;
            }

            .header {
                padding: 15px 0;
            }

            .header-title {
                font-size: 1.3em;
            }

            .btn {
                padding: 8px 16px;
                font-size: 13px;
                border-radius: 20px;
            }

            .search-container {
                padding: 20px 0;
            }

            .search-input {
                font-size: 16px !important;
                padding: 12px 45px 12px 16px;
                border-radius: 20px;
            }

            .search-close-btn {
                right: 12px;
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            .category-container {
                padding: 15px 0;
            }

            .category-header h3 {
                font-size: 1.1em;
            }

            .category-chips {
                gap: 8px;
            }

            .category-chip {
                padding: 6px 12px;
                font-size: 0.8em;
                border-radius: 16px;
            }

            .category-count {
                font-size: 0.7em;
                padding: 1px 4px;
            }

            .status {
                padding: 15px 0;
                font-size: 14px;
                line-height: 1.4;
            }

            .articles-section {
                padding: 20px 0;
            }

            .articles-grid {
                display: block;
                margin-top: 15px;
            }

            .article-card {
                display: block !important;
                width: 100% !important;
                margin-bottom: 20px !important;
                border-radius: 20px !important;
                overflow: hidden;
                background: var(--surface);
                border: 1px solid var(--border);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                transform: none !important;
                animation: none !important;
            }

            .article-card:hover {
                transform: none !important;
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
            }

            .article-image {
                width: 100% !important;
                height: 140px !important;
                border-radius: 20px 20px 0 0 !important;
                position: relative;
            }

            .article-content {
                padding: 20px !important;
                cursor: pointer;
            }

            .article-title {
                font-size: 1.25em !important;
                font-weight: 600;
                margin-bottom: 10px !important;
                line-height: 1.4 !important;
                color: var(--text-primary);
                display: block !important;
                -webkit-line-clamp: unset !important;
                -webkit-box-orient: unset !important;
                overflow: visible !important;
            }

            .article-excerpt {
                font-size: 1em !important;
                line-height: 1.5 !important;
                margin-bottom: 15px !important;
                color: var(--text-secondary);
                display: block !important;
                -webkit-line-clamp: unset !important;
                -webkit-box-orient: unset !important;
                overflow: visible !important;
            }

            .article-meta {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 8px;
                color: var(--text-secondary);
                font-size: 0.9em !important;
                margin-bottom: 10px;
            }

            .article-stats {
                display: flex;
                gap: 15px;
                font-size: 0.85em !important;
                color: var(--text-secondary);
                margin-bottom: 10px;
            }

            .article-actions {
                position: static !important;
                opacity: 1 !important;
                visibility: visible !important;
                display: flex !important;
                justify-content: center;
                gap: 12px;
                padding: 15px 20px;
                background: var(--background);
                border-radius: 0;
                margin: 0;
                border-top: 1px solid var(--border);
            }

            .action-btn {
                min-width: 45px !important;
                height: 45px !important;
                font-size: 18px !important;
                border-radius: 50% !important;
                padding: 0;
                background: var(--surface);
                border: 2px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .action-btn:hover,
            .action-btn:active {
                border-radius: 50% !important;
                transform: scale(1.05);
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .reader-overlay {
                padding: 0;
            }

            .reader-container {
                margin: 0 !important;
                border-radius: 0 !important;
                height: 100vh;
                max-width: none;
                display: flex;
                flex-direction: column;
            }

            .reader-header {
                padding: 20px;
                border-radius: 0;
                flex-shrink: 0;
            }

            .reader-title {
                font-size: 1.4em !important;
                line-height: 1.3;
                margin-bottom: 15px;
            }

            .reader-meta {
                font-size: 0.9em;
                gap: 15px;
            }

            .reader-content {
                padding: 20px;
                font-size: 1.1em !important;
                line-height: 1.7 !important;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .close-reader {
                top: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .search-input {
                font-size: 16px !important;
                padding: 14px 50px 14px 18px;
            }

            .empty-state {
                padding: 40px 20px;
            }

            .empty-state-icon {
                font-size: 3em;
                margin-bottom: 15px;
            }

            .empty-state h3 {
                font-size: 1.3em;
                margin-bottom: 8px;
            }

            .empty-state p {
                font-size: 1em;
                line-height: 1.5;
            }
        }

        @media (max-width: 480px) {
            .article-title {
                font-size: 1.15em !important;
            }

            .article-excerpt {
                font-size: 0.95em !important;
            }

            .article-content {
                padding: 16px !important;
            }

            .header-actions {
                gap: 6px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* Dark mode styles */
        [data-theme="dark"] .sidebar {
            background: var(--surface);
            border-right-color: var(--border);
        }

        [data-theme="dark"] .sidebar-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }

        [data-theme="dark"] .nav-item {
            color: var(--text-primary);
        }

        [data-theme="dark"] .nav-item:hover {
            background: var(--background);
        }

        [data-theme="dark"] .nav-item.active {
            background: var(--background);
            color: var(--primary-color);
        }

        [data-theme="dark"] .article-card {
            background: var(--surface);
            border: 1px solid var(--border);
        }

        [data-theme="dark"] .article-card:hover {
            border-color: #484f58;
            transform: translateY(-2px) scale(1.02);
        }

        [data-theme="dark"] .search-input {
            background: var(--surface);
            border-color: var(--border);
            color: var(--text-primary);
        }

        [data-theme="dark"] .search-input:focus {
            border-color: var(--primary-color);
            background: var(--surface);
        }

        [data-theme="dark"] .search-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        [data-theme="dark"] .search-close-btn:hover {
            background: #21262d;
            color: var(--text-primary);
        }

        [data-theme="dark"] .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border-color: var(--border);
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: #21262d;
            border-color: #484f58;
            color: var(--text-primary);
        }

        [data-theme="dark"] .action-btn {
            background: rgba(22, 27, 34, 0.95);
            border-color: var(--border);
            color: var(--text-primary);
            backdrop-filter: blur(10px);
        }

        [data-theme="dark"] .action-btn:hover {
            background: rgba(33, 38, 45, 0.95);
            border-color: #484f58;
        }

        [data-theme="dark"] .read-btn:hover {
            background: rgba(13, 110, 253, 0.2);
            border-color: #0d6efd;
            color: #58a6ff;
        }

        [data-theme="dark"] .export-btn:hover {
            background: rgba(25, 135, 84, 0.2);
            border-color: #198754;
            color: #3fb950;
        }

        [data-theme="dark"] .refresh-image-btn:hover {
            background: rgba(255, 152, 0, 0.2);
            border-color: #ff9800;
            color: #ffb74d;
        }

        [data-theme="dark"] .delete-btn:hover {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            color: #f85149;
        }

        [data-theme="dark"] .reader-container {
            background: var(--surface);
            border: 1px solid var(--border);
        }

        [data-theme="dark"] .reader-header {
            background: var(--background);
            border-bottom-color: var(--border);
        }

        [data-theme="dark"] .reader-content {
            color: var(--text-primary);
        }

        [data-theme="dark"] .reader-content h1,
        [data-theme="dark"] .reader-content h2,
        [data-theme="dark"] .reader-content h3 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .reader-content blockquote {
            background: var(--background);
            border-left-color: var(--primary-color);
        }

        [data-theme="dark"] .close-reader {
            background: var(--primary-color);
        }

        [data-theme="dark"] .empty-state {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .empty-state h3 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .connection-status.connected {
            background: rgba(25, 135, 84, 0.2);
            border-color: #198754;
            color: #3fb950;
        }

        [data-theme="dark"] .connection-status.disconnected {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            color: #f85149;
        }

        [data-theme="dark"] .cache-indicator.synced {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        [data-theme="dark"] .cache-indicator.fallback {
            background: rgba(255, 152, 0, 0.9);
            color: white;
        }

        [data-theme="dark"] .cache-indicator.metadata {
            background: rgba(103, 58, 183, 0.9);
            color: white;
        }

        [data-theme="dark"] .cache-indicator.error {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }

        [data-theme="dark"] .category-container {
            background: var(--surface);
            border-bottom-color: var(--border);
        }

        [data-theme="dark"] .category-header h3 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .category-close-btn:hover {
            background: #21262d;
            color: var(--text-primary);
        }

        [data-theme="dark"] .category-chip {
            background: var(--surface);
            border-color: var(--border);
            color: var(--text-primary);
        }

        [data-theme="dark"] .category-chip:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        [data-theme="dark"] .category-chip.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        [data-theme="dark"] .category-chip:not(.active) .category-count {
            background: var(--border);
            color: var(--text-secondary);
        }

        /* Firefox Mobile Specific Fixes */
        @-moz-document url-prefix() {
            @media (max-width: 768px) {
                .article-card {
                    will-change: auto;
                }

                .articles-grid {
                    transform: translateZ(0);
                }

                .search-input {
                    -moz-appearance: none;
                }

                .btn {
                    -moz-appearance: none;
                }
            }
        }

        /* Background pattern animation for generated placeholders */
        @keyframes floatPattern {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /* Shimmer animation for loading placeholders */
        @keyframes shimmer {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .article-card:nth-child(7n+1) {
            animation: float 6s ease-in-out infinite;
            animation-delay: 0s;
        }

        .article-card:nth-child(7n+2) {
            animation: float 6s ease-in-out infinite;
            animation-delay: 0.5s;
        }

        .article-card:nth-child(7n+3) {
            animation: float 6s ease-in-out infinite;
            animation-delay: 1s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        /* Organic gradient backgrounds for images */
        .article-image:nth-child(odd) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .article-image:nth-child(3n+1) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .article-image:nth-child(3n+2) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .article-image:nth-child(3n+3) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .article-image:nth-child(5n+1) {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        /* Hidden by default */
        .hidden {
            display: none !important;
        }

        /* Mobile overlay backdrop */
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .mobile-overlay.active {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>

<body>
    <!-- FIXED: Proper Vertical Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                📚 MyPocket AI Reader
            </div>
            <div class="connection-status" id="connectionStatus">
                <span>🔐</span>
                <span>Secure Connect Required</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Library</div>
                <button class="nav-item active" id="allArticlesBtn">
                    <span class="icon">📚</span>
                    <span class="label">All Articles</span>
                    <span class="badge" id="allArticleCount">0</span>
                </button>
                <button class="nav-item" id="unreadBtn">
                    <span class="icon">📖</span>
                    <span class="label">Unread</span>
                    <span class="badge" id="unreadCount">0</span>
                </button>
                <button class="nav-item" id="favoritesBtn">
                    <span class="icon">⭐</span>
                    <span class="label">Favorites</span>
                    <span class="badge" id="favoritesCount">0</span>
                </button>
                <button class="nav-item" id="archiveBtn">
                    <span class="icon">📦</span>
                    <span class="label">Archive</span>
                    <span class="badge" id="archiveCount">0</span>
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Smart Categories</div>
                <button class="nav-item" id="categoriesBtn">
                    <span class="icon">🏷️</span>
                    <span class="label">All Categories</span>
                    <span class="badge" id="categoryCount">0</span>
                </button>
                <div id="dynamicCategoryNav"></div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Actions</div>
                <button class="nav-item" id="connectBtn">
                    <span class="icon">☁️</span>
                    <span class="label">Connect to OneDrive</span>
                </button>
                <button class="nav-item" id="refreshBtn" style="display: none;">
                    <span class="icon">🔄</span>
                    <span class="label">Refresh Articles</span>
                </button>
                <button class="nav-item" id="syncBtn" style="display: none;">
                    <span class="icon">🔄</span>
                    <span class="label">Sync Images</span>
                </button>
                <button class="nav-item" id="retryFailedBtn" style="display: none;">
                    <span class="icon">🔄</span>
                    <span class="label">Retry Failed</span>
                </button>
                <button class="nav-item" id="clearCacheBtn">
                    <span class="icon">🗑️</span>
                    <span class="label">Clear Cache</span>
                </button>
                <button class="nav-item" id="imageHelpBtn">
                    <span class="icon">❓</span>
                    <span class="label">Image Help</span>
                </button>
                <button class="nav-item" id="debugBtn">
                    <span class="icon">🔧</span>
                    <span class="label">Enhanced Debug</span>
                </button>
                <button class="nav-item" id="testModeBtn">
                    <span class="icon">👁️</span>
                    <span class="label">Show Buttons</span>
                </button>
                <button class="nav-item" id="darkModeBtn">
                    <span class="icon">🌙</span>
                    <span class="label">Dark Mode</span>
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">AI Settings</div>
                <button class="nav-item" id="strictModeBtn">
                    <span class="icon">🎯</span>
                    <span class="label">Strict Mode</span>
                </button>
                <button class="nav-item" id="balancedModeBtn">
                    <span class="icon">⚖️</span>
                    <span class="label">Balanced Mode</span>
                </button>
                <button class="nav-item" id="permissiveModeBtn">
                    <span class="icon">🌊</span>
                    <span class="label">Permissive Mode</span>
                </button>
                <button class="nav-item" id="recategorizeBtn">
                    <span class="icon">🤖</span>
                    <span class="label">Re-categorize All</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Mobile overlay backdrop -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div>
                        <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>
                        <span class="header-title" id="pageTitle">All Articles</span>
                    </div>
                    <div class="header-actions">
                        <button id="searchToggleBtn" class="btn btn-secondary">
                            <span>🔍</span> Search
                        </button>
                        <button id="categoriesHeaderBtn" class="btn btn-secondary">
                            <span>🏷️</span> Categories
                        </button>
                        <button id="darkModeHeaderBtn" class="btn btn-secondary">
                            <span>🌙</span> Dark Mode
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Search (Initially Hidden) -->
        <section class="search-container" id="searchContainer" style="display: none;">
            <div class="container">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search your saved articles..."
                        autocomplete="off">
                    <button class="search-close-btn" id="searchCloseBtn" title="Close search">✕</button>
                </div>
            </div>
        </section>

        <!-- Enhanced AI Category Filter (Initially Hidden) -->
        <section class="category-container" id="categoryContainer" style="display: none;">
            <div class="container">
                <div class="category-filter">
                    <div class="category-header">
                        <h3>📂 AI-Powered Category Filter</h3>
                        <button class="category-close-btn" id="categoryCloseBtn"
                            title="Close categories">✕</button>
                    </div>
                    <div class="category-chips" id="categoryChips">
                        <!-- AI-generated categories will be populated here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Status -->
        <div class="status" id="status">
            Connect to OneDrive to view your saved articles with intelligent AI categorization
        </div>

        <!-- Articles -->
        <section class="articles-section">
            <div class="container">
                <div id="articlesContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">🤖</div>
                        <h3>Welcome to MyPocket AI Reader</h3>
                        <p>Connect to OneDrive to access your saved articles with intelligent AI categorization and cross-device image sync!</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Reader Overlay -->
    <div class="reader-overlay" id="readerOverlay">
        <div class="reader-container">
            <button class="close-reader" id="closeReader">✕</button>
            <div class="reader-header">
                <h1 class="reader-title" id="readerTitle">Article Title</h1>
                <div class="reader-meta" id="readerMeta">
                    <span>📅 <span id="readerDate">Date</span></span>
                    <span>🌐 <span id="readerDomain">Domain</span></span>
                    <span>⏱️ <span id="readerTime">5 min read</span></span>
                </div>
                <div class="reader-actions">
                    <button class="btn btn-secondary" id="openOriginal">
                        🔗 Open Original
                    </button>
                </div>
            </div>
            <div class="reader-content" id="readerContent">
                Article content will appear here...
            </div>
        </div>
    </div>

    <script>
        class MyPocketWebReader {
            constructor() {
                // FIXED: Use your actual Azure AD client ID
                this.clientId = '436e8796-8c40-47c3-9ad5-b8882f3ef7f7';
                this.redirectUri = this.getRedirectUri();
                console.log('🔵 Redirect URI:', this.redirectUri);

                this.accessToken = null;
                this.articles = [];
                this.currentArticle = null;
                this.currentDisplayedArticles = [];
                this.failedImages = new Set();

                // Enhanced AI-powered categorization system
                this.categories = new Map();
                this.activeCategory = null;
                this.dynamicCategories = new Map();
                this.categoryKeywords = this.initializeCategoryKeywords();
                this.stopWords = this.initializeStopWords();
                
                // ENHANCED: AI categorization settings - much more sophisticated
                this.enableDynamicCategories = true;
                this.minCategoryConfidence = 35; // Balanced threshold
                this.maxCategories = 20;

                // Image cache system
                this.imageCache = new Map();
                this.cacheKey = 'mypocket_image_cache';
                this.cacheExpiryDays = 7;

                // Cross-device image storage
                this.storeImagesInBackup = true;
                this.maxImageSizeKB = 500;
                this.cacheSaveTimeout = null;

                // PKCE-specific properties
                this.codeVerifier = null;
                this.codeChallenge = null;
                this.state = null;

                // Domain-specific categorization rules
                this.domainCategoryRules = {};

                // Search and filter state
                this.currentSearchTerm = '';
                this.showSearch = false;
                this.showCategories = false;

                this.init();
            }

            getRedirectUri() {
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.split('#')[0].split('?')[0];

                if (baseUrl.startsWith('http://') || baseUrl.startsWith('https://')) {
                    return baseUrl;
                } else {
                    return window.location.origin + window.location.pathname;
                }
            }

            // ===== ENHANCED AI CATEGORIZATION SYSTEM =====

            initializeStopWords() {
                return new Set([
                    'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by',
                    'how', 'what', 'why', 'when', 'where', 'who', 'which', 'this', 'that', 'these', 'those',
                    'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did',
                    'will', 'would', 'could', 'should', 'may', 'might', 'can', 'must', 'shall', 'here', 'there',
                    'up', 'down', 'out', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'now',
                    'very', 'too', 'just', 'only', 'own', 'same', 'so', 'than', 'too', 'any', 'some', 'all',
                    'each', 'more', 'most', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than',
                    'into', 'from', 'they', 'them', 'their', 'we', 'us', 'our', 'you', 'your', 'he', 'him',
                    'his', 'she', 'her', 'it', 'its', 'me', 'my', 'i', 'get', 'got', 'make', 'made', 'take',
                    'took', 'see', 'saw', 'go', 'went', 'come', 'came', 'know', 'knew', 'think', 'thought',
                    'say', 'said', 'tell', 'told', 'ask', 'asked', 'give', 'gave', 'find', 'found', 'work',
                    'worked', 'call', 'called', 'try', 'tried', 'need', 'needed', 'feel', 'felt', 'become',
                    'became', 'leave', 'left', 'put', 'putting', 'mean', 'meant', 'keep', 'kept', 'let',
                    'begin', 'began', 'seem', 'seemed', 'help', 'helped', 'talk', 'talked', 'turn', 'turned',
                    'start', 'started', 'show', 'showed', 'hear', 'heard', 'play', 'played', 'run', 'ran',
                    'move', 'moved', 'live', 'lived', 'believe', 'believed', 'bring', 'brought', 'happen',
                    'happened', 'write', 'wrote', 'provide', 'provided', 'sit', 'sat', 'stand', 'stood',
                    'lose', 'lost', 'pay', 'paid', 'meet', 'met', 'include', 'included', 'continue', 'continued',
                    'set', 'follow', 'followed', 'around', 'between', 'during', 'before', 'after', 'above',
                    'below', 'against', 'through', 'while', 'without', 'within', 'along', 'among', 'across',
                    'behind', 'beyond', 'since', 'until', 'unless', 'although', 'because', 'however',
                    'therefore', 'moreover', 'furthermore', 'nevertheless', 'meanwhile', 'otherwise',
                    'article', 'articles', 'post', 'posts', 'blog', 'blogs', 'page', 'pages', 'website',
                    'site', 'link', 'links', 'read', 'reading', 'content', 'text', 'information', 'info'
                ]);
            }

            // ENHANCED: Massively expanded category keywords with better matching
            initializeCategoryKeywords() {
                return {
                    'Technology': {
                        icon: '💻',
                        priority: 'high',
                        keywords: [
                            'programming', 'code', 'coding', 'development', 'developer', 'software', 'algorithm',
                            'javascript', 'python', 'java', 'react', 'nodejs', 'api', 'database', 'sql',
                            'frontend', 'backend', 'fullstack', 'framework', 'library', 'github', 'git',
                            'open source', 'debugging', 'testing', 'deployment', 'devops', 'cloud',
                            'artificial intelligence', 'machine learning', 'ai', 'ml', 'blockchain',
                            'cryptocurrency', 'bitcoin', 'ethereum', 'nft', 'metaverse', 'vr', 'ar',
                            'virtual reality', 'augmented reality', 'iot', 'internet of things',
                            'mobile', 'android', 'ios', 'web development', 'responsive', 'pwa',
                            'app development', 'xamarin', 'flutter', 'react native', 'tech', 'digital',
                            'computer', 'software', 'hardware', 'cybersecurity', 'data', 'analytics',
                            'startup', 'innovation', 'automation', 'robotics', 'saas', 'platform',
                            'typescript', 'nextjs', 'vuejs', 'angular', 'svelte', 'tailwind',
                            'webpack', 'vite', 'npm', 'yarn', 'docker', 'kubernetes',
                            'microservices', 'serverless', 'lambda', 'firebase', 'supabase',
                            'graphql', 'rest api', 'websocket', 'grpc', 'oauth', 'jwt',
                            'redis', 'mongodb', 'postgresql', 'mysql', 'sqlite',
                            'testing', 'jest', 'cypress', 'playwright', 'unit test',
                            'deployment', 'ci/cd', 'github actions', 'gitlab', 'jenkins'
                        ],
                        domains: ['github.com', 'stackoverflow.com', 'dev.to', 'techcrunch.com', 'theverge.com', 
                                'arstechnica.com', 'wired.com', 'hacker-news.firebaseio.com', 'news.ycombinator.com',
                                'medium.com/tag/technology', 'freecodecamp.org', 'codepen.io', 'gitlab.com', 'bitbucket.org']
                    },
                    'AI & Machine Learning': {
                        icon: '🤖',
                        priority: 'high',
                        keywords: [
                            'artificial intelligence', 'machine learning', 'deep learning',
                            'neural network', 'tensorflow', 'pytorch', 'keras',
                            'transformer', 'gpt', 'llm', 'bert', 'attention',
                            'supervised learning', 'unsupervised learning', 'reinforcement learning',
                            'classification', 'regression', 'clustering', 'nlp',
                            'computer vision', 'opencv', 'scikit-learn', 'pandas',
                            'numpy', 'matplotlib', 'jupyter', 'colab', 'kaggle',
                            'dataset', 'training', 'validation', 'testing',
                            'overfitting', 'underfitting', 'bias', 'variance',
                            'gradient descent', 'backpropagation', 'optimization',
                            'large language model', 'chatgpt', 'openai', 'anthropic',
                            'generative ai', 'diffusion', 'stable diffusion', 'dall-e'
                        ],
                        domains: ['arxiv.org', 'paperswithcode.com', 'openai.com', 'huggingface.co', 'kaggle.com']
                    },
                    'Web Development': {
                        icon: '🌐',
                        priority: 'high',
                        keywords: [
                            'web development', 'frontend', 'backend', 'fullstack',
                            'html', 'css', 'javascript', 'typescript', 'react',
                            'vue', 'angular', 'svelte', 'nextjs', 'nuxt',
                            'responsive', 'mobile first', 'progressive web app',
                            'spa', 'ssr', 'ssg', 'jamstack', 'headless',
                            'dom', 'browser', 'webkit', 'chrome', 'firefox',
                            'http', 'https', 'server', 'client', 'ajax'
                        ],
                        domains: ['mdn.mozilla.org', 'web.dev', 'css-tricks.com', 'smashingmagazine.com']
                    },
                    'Politics': {
                        icon: '🏛️',
                        priority: 'high',
                        keywords: [
                            'politics', 'political', 'government', 'governance', 'election', 'voting', 'democracy', 
                            'republican', 'democratic', 'congress', 'senate', 'house', 'president', 'prime minister', 
                            'minister', 'policy', 'legislation', 'law', 'bill', 'campaign', 'candidate', 'politician',
                            'parliament', 'capitol', 'white house', 'administration', 'cabinet', 'supreme court',
                            'judicial', 'executive', 'legislative', 'impeachment', 'scandal', 'corruption',
                            'debate', 'rally', 'protest', 'activism', 'conservative', 'liberal', 'progressive',
                            'libertarian', 'socialist', 'communist', 'fascist', 'authoritarian', 'totalitarian',
                            'diplomatic', 'diplomacy', 'international relations', 'foreign policy', 'treaty',
                            'sanctions', 'embargo', 'summit', 'nato', 'un', 'united nations', 'eu', 'brexit',
                            'trump', 'biden', 'harris', 'pelosi', 'mcconnell', 'senate', 'congress'
                        ],
                        domains: ['politico.com', 'washingtonpost.com/politics', 'cnn.com/politics', 
                                'foxnews.com/politics', 'bbc.com/news/politics', 'reuters.com/politics',
                                'apnews.com/politics', 'npr.org/politics', 'thehill.com', 'rollcall.com']
                    },
                    'Business': {
                        icon: '💼',
                        priority: 'high',
                        keywords: [
                            'business', 'startup', 'entrepreneur', 'entrepreneurship', 'finance', 'investment',
                            'venture capital', 'vc', 'funding', 'ipo', 'stock market', 'trading', 'economics',
                            'marketing', 'sales', 'strategy', 'management', 'leadership', 'ceo', 'founder',
                            'company', 'corporation', 'revenue', 'profit', 'growth', 'market share',
                            'branding', 'advertising', 'digital marketing', 'seo', 'sem', 'social media marketing',
                            'customer acquisition', 'retention', 'conversion', 'analytics', 'metrics',
                            'productivity', 'workflow', 'automation', 'efficiency', 'remote work',
                            'team management', 'project management', 'agile', 'scrum', 'collaboration',
                            'money', 'financial', 'economy', 'market', 'industry', 'corporate',
                            'saas', 'b2b', 'b2c', 'customer', 'user', 'product',
                            'feature', 'roadmap', 'sprint', 'agile', 'scrum',
                            'conversion', 'retention', 'churn', 'lifetime value',
                            'acquisition', 'funnel', 'analytics', 'metrics',
                            'kpi', 'roi', 'growth hacking', 'viral', 'referral'
                        ],
                        domains: ['linkedin.com', 'forbes.com', 'bloomberg.com', 'businessinsider.com', 
                                'harvard.business.review', 'wsj.com', 'ft.com', 'entrepreneur.com',
                                'inc.com', 'fastcompany.com', 'techcrunch.com', 'crunchbase.com']
                    },
                    'Science': {
                        icon: '🔬',
                        priority: 'high',
                        keywords: [
                            'science', 'research', 'study', 'experiment', 'discovery', 'theory', 'hypothesis',
                            'biology', 'chemistry', 'physics', 'mathematics', 'statistics', 'data science',
                            'medicine', 'medical', 'clinical', 'pharmaceutical', 'drug', 'vaccine',
                            'climate', 'environment', 'sustainability', 'renewable energy', 'solar', 'wind',
                            'space', 'astronomy', 'nasa', 'spacex', 'mars', 'rocket', 'satellite',
                            'genetics', 'dna', 'genome', 'crispr', 'biotechnology', 'biotech',
                            'neuroscience', 'brain', 'psychology', 'cognitive', 'mental health',
                            'quantum', 'particle', 'energy', 'nuclear', 'microscopy', 'telescope',
                            'scientific', 'laboratory', 'analysis', 'methodology'
                        ],
                        domains: ['arxiv.org', 'nature.com', 'science.org', 'plos.org', 'pubmed.ncbi.nlm.nih.gov',
                                'scientificamerican.com', 'newscientist.com', 'sciencedaily.com', 'cell.com']
                    },
                    'Design': {
                        icon: '🎨',
                        priority: 'medium',
                        keywords: [
                            'design', 'ui', 'ux', 'user experience', 'user interface', 'visual design',
                            'graphic design', 'web design', 'product design', 'interaction design',
                            'creative', 'art', 'illustration', 'typography', 'font', 'color', 'palette',
                            'layout', 'composition', 'grid', 'wireframe', 'prototype', 'mockup',
                            'figma', 'sketch', 'adobe', 'photoshop', 'illustrator', 'indesign',
                            'branding', 'logo', 'identity', 'brand', 'aesthetic', 'minimalism',
                            'accessibility', 'usability', 'human centered', 'design thinking',
                            'portfolio', 'dribbble', 'behance', 'awwwards', 'designer'
                        ],
                        domains: ['dribbble.com', 'behance.net', 'medium.com/tag/design', 'uxdesign.cc',
                                'smashingmagazine.com', 'designmodo.com', 'awwwards.com', 'uxplanet.org']
                    },
                    'Health': {
                        icon: '🏥',
                        priority: 'high',
                        keywords: [
                            'health', 'healthy', 'wellness', 'fitness', 'exercise', 'workout', 'training',
                            'nutrition', 'diet', 'food', 'eating', 'weight loss', 'muscle', 'strength',
                            'cardio', 'running', 'yoga', 'meditation', 'mindfulness', 'mental health',
                            'medical', 'medicine', 'doctor', 'physician', 'patient', 'treatment',
                            'therapy', 'rehabilitation', 'recovery', 'surgery', 'hospital', 'clinic',
                            'disease', 'illness', 'symptoms', 'diagnosis', 'prevention', 'immune',
                            'vitamin', 'supplement', 'organic', 'natural', 'holistic', 'alternative',
                            'healthcare', 'pharmaceutical', 'drug', 'vaccine'
                        ],
                        domains: ['mayoclinic.org', 'webmd.com', 'healthline.com', 'nih.gov', 'who.int',
                                'medicalnewstoday.com', 'everydayhealth.com', 'health.com', 'myfitnesspal.com']
                    },
                    'Entertainment': {
                        icon: '🎬',
                        priority: 'medium',
                        keywords: [
                            'entertainment', 'movie', 'film', 'cinema', 'tv', 'television', 'show', 'series',
                            'streaming', 'netflix', 'disney', 'hulu', 'amazon prime', 'hbo', 'youtube',
                            'music', 'song', 'album', 'artist', 'musician', 'concert', 'festival',
                            'spotify', 'apple music', 'podcast', 'gaming', 'video game', 'game',
                            'esports', 'twitch', 'steam', 'playstation', 'xbox', 'nintendo',
                            'celebrity', 'actor', 'actress', 'director', 'producer', 'hollywood',
                            'review', 'rating', 'critic', 'trailer', 'release', 'box office'
                        ],
                        domains: ['youtube.com', 'netflix.com', 'spotify.com', 'imdb.com', 'ign.com',
                                'gamespot.com', 'polygon.com', 'variety.com', 'hollywoodreporter.com']
                    }
                };
            }

            // ENHANCED: Improved keyword extraction with better text analysis and error handling
            extractKeywords(text) {
                try {
                    console.log(`🔤 Extracting keywords from ${text.length} characters...`);
                    
                    if (!text || typeof text !== 'string' || text.length < 10) {
                        console.log(`⚠️ Invalid or too short text for keyword extraction`);
                        return [];
                    }
                    
                    // Enhanced text preprocessing
                    const cleanText = text.toLowerCase()
                        .replace(/[^\w\s-]/g, ' ')  // Keep hyphens for compound words
                        .replace(/\s+/g, ' ')       // Normalize whitespace
                        .trim();
                    
                    const words = cleanText.split(/\s+/)
                        .filter(word => {
                            // More sophisticated filtering
                            return word && 
                                   typeof word === 'string' &&
                                   word.length >= 3 &&           // Minimum length
                                   word.length <= 25 &&          // Maximum length (avoid URLs)
                                   !this.stopWords.has(word) &&  // Not a stop word
                                   !/^\d+$/.test(word) &&        // Not just numbers
                                   !word.includes('http') &&     // Not part of URL
                                   !/^[a-z]\d/.test(word);       // Not code-like (e.g., "h1", "p2")
                        });

                    if (words.length === 0) {
                        console.log(`⚠️ No valid words found after filtering`);
                        return [];
                    }

                    console.log(`📝 Filtered to ${words.length} meaningful words from ${cleanText.split(/\s+/).length} total`);

                    // Calculate enhanced word frequencies with context
                    const wordFreq = new Map();
                    
                    words.forEach((word) => {
                        try {
                            wordFreq.set(word, (wordFreq.get(word) || 0) + 1);
                        } catch (error) {
                            console.log(`⚠️ Error processing word "${word}":`, error);
                        }
                    });

                    // Enhanced TF-IDF-like scoring with domain knowledge
                    const totalWords = words.length;
                    const keywordScores = [];

                    wordFreq.forEach((freq, word) => {
                        try {
                            if (freq < 2) return; // Must appear at least twice
                            
                            // Base term frequency
                            const tf = freq / totalWords;
                            
                            // Length bonus (longer words often more meaningful)
                            const lengthBonus = Math.min(word.length / 6, 2);
                            
                            // Technical term detection
                            const techBonus = this.getTechnicalBonus(word);
                            
                            // Domain-specific importance
                            const domainBonus = this.getDomainSpecificBonus(word);
                            
                            // Position bonus (words appearing early might be more important)
                            const firstOccurrence = words.indexOf(word);
                            const positionBonus = firstOccurrence < totalWords * 0.3 ? 1.2 : 1;
                            
                            const finalScore = tf * lengthBonus * techBonus * domainBonus * positionBonus * freq;
                            
                            if (finalScore > 0.002) { // Minimum threshold
                                keywordScores.push({ 
                                    word, 
                                    score: finalScore, 
                                    freq, 
                                    details: { tf, lengthBonus, techBonus, domainBonus, positionBonus }
                                });
                            }
                        } catch (error) {
                            console.log(`⚠️ Error scoring word "${word}":`, error);
                        }
                    });

                    const topKeywords = keywordScores
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 25)  // Get more keywords for better analysis
                        .map(item => item.word);

                    console.log(`🎯 Extracted ${topKeywords.length} keywords:`, topKeywords.slice(0, 10).join(', '));
                    return topKeywords;

                } catch (error) {
                    console.error('❌ Error in extractKeywords:', error);
                    return [];
                }
            }

            getTechnicalBonus(word) {
                // Check if word appears to be technical/domain-specific
                const technicalPatterns = [
                    /^[a-z]+js$/, // JavaScript libraries
                    /^[a-z]+css$/, // CSS frameworks
                    /api$/, // APIs
                    /^[a-z]+sql$/, // Database related
                    /framework/, // Frameworks
                    /^micro/, // Microservices etc
                    /^auto/ // Automation etc
                ];
                
                return technicalPatterns.some(pattern => pattern.test(word)) ? 1.5 : 1;
            }

            getDomainSpecificBonus(word) {
                // Check if word appears in our category keywords
                for (const [category, data] of Object.entries(this.categoryKeywords)) {
                    if (data.keywords.includes(word)) {
                        return data.priority === 'high' ? 2 : 1.5;
                    }
                }
                return 1;
            }

            // ENHANCED: Sophisticated AI categorization with confidence scoring
            categorizeArticle(article) {
                try {
                    console.log(`🏷️ Categorizing article: "${article.title?.substring(0, 50)}..."`);
                    
                    const text = `${article.title || ''} ${article.excerpt || ''} ${article.content || ''}`.toLowerCase();
                    const domain = article.domain || '';
                    
                    if (!text.trim()) {
                        console.log('⚠️ No text available for categorization');
                        return null;
                    }

                    const categoryScores = new Map();
                    
                    // Extract keywords for analysis
                    const keywords = this.extractKeywords(text);
                    
                    // Score each category
                    for (const [categoryName, categoryData] of Object.entries(this.categoryKeywords)) {
                        let score = 0;
                        let matchedKeywords = [];
                        
                        // Keyword matching
                        categoryData.keywords.forEach(keyword => {
                            if (text.includes(keyword)) {
                                const keywordScore = keyword.length > 5 ? 2 : 1; // Longer keywords more specific
                                score += keywordScore;
                                matchedKeywords.push(keyword);
                            }
                        });
                        
                        // Domain matching bonus
                        if (categoryData.domains && categoryData.domains.some(d => domain.includes(d))) {
                            score += 10; // Strong domain signal
                            matchedKeywords.push(`domain:${domain}`);
                        }
                        
                        // Priority bonus
                        if (categoryData.priority === 'high') {
                            score *= 1.2;
                        }
                        
                        // Title matching bonus (title words are more important)
                        if (article.title) {
                            categoryData.keywords.forEach(keyword => {
                                if (article.title.toLowerCase().includes(keyword)) {
                                    score += 3; // Strong title signal
                                }
                            });
                        }
                        
                        if (score > 0) {
                            categoryScores.set(categoryName, {
                                score,
                                matchedKeywords,
                                confidence: Math.min(Math.round((score / text.length) * 1000), 100)
                            });
                        }
                    }
                    
                    if (categoryScores.size === 0) {
                        console.log('❓ No category matches found');
                        return null;
                    }
                    
                    // Get best category
                    const sortedCategories = Array.from(categoryScores.entries())
                        .sort(([,a], [,b]) => b.score - a.score);
                    
                    const [bestCategory, bestScore] = sortedCategories[0];
                    
                    // Only return if confidence meets threshold
                    if (bestScore.confidence >= this.minCategoryConfidence) {
                        console.log(`✅ Categorized as "${bestCategory}" (confidence: ${bestScore.confidence}%)`);
                        console.log(`🔍 Keywords: ${bestScore.matchedKeywords.slice(0, 5).join(', ')}`);
                        
                        return {
                            category: bestCategory,
                            confidence: bestScore.confidence,
                            icon: this.categoryKeywords[bestCategory]?.icon || '📄',
                            matchedKeywords: bestScore.matchedKeywords
                        };
                    } else {
                        console.log(`🤔 Best category "${bestCategory}" below confidence threshold (${bestScore.confidence}% < ${this.minCategoryConfidence}%)`);
                        return null;
                    }
                    
                } catch (error) {
                    console.error('❌ Error categorizing article:', error);
                    return null;
                }
            }

            init() {
                console.log('🚀 Initializing MyPocket Web Reader...');
                
                // Apply saved dark mode preference
                const savedDarkMode = localStorage.getItem('darkMode') === 'true';
                if (savedDarkMode) {
                    document.body.setAttribute('data-theme', 'dark');
                }

                this.setupEventListeners();
                this.checkAuthenticationStatus();
                this.loadSampleArticles(); // For demo purposes
            }

            setupEventListeners() {
                console.log('🎯 Setting up event listeners...');

                // Navigation
                document.getElementById('allArticlesBtn')?.addEventListener('click', () => this.showAllArticles());
                document.getElementById('unreadBtn')?.addEventListener('click', () => this.showUnread());
                document.getElementById('favoritesBtn')?.addEventListener('click', () => this.showFavorites());
                document.getElementById('archiveBtn')?.addEventListener('click', () => this.showArchive());

                // Actions
                document.getElementById('connectBtn')?.addEventListener('click', () => this.authenticate());
                document.getElementById('refreshBtn')?.addEventListener('click', () => this.loadArticles());
                document.getElementById('syncBtn')?.addEventListener('click', () => this.forceSyncImages());
                document.getElementById('retryFailedBtn')?.addEventListener('click', () => this.retryFailedImages());
                document.getElementById('clearCacheBtn')?.addEventListener('click', () => this.clearImageCache());
                document.getElementById('imageHelpBtn')?.addEventListener('click', () => this.showImageHelp());
                document.getElementById('debugBtn')?.addEventListener('click', () => this.showEnhancedDebugInfo());
                document.getElementById('testModeBtn')?.addEventListener('click', () => this.toggleTestMode());
                document.getElementById('darkModeBtn')?.addEventListener('click', () => this.toggleDarkMode());
                document.getElementById('darkModeHeaderBtn')?.addEventListener('click', () => this.toggleDarkMode());

                // AI Settings
                document.getElementById('strictModeBtn')?.addEventListener('click', () => this.adjustCategorizationSettings('strict'));
                document.getElementById('balancedModeBtn')?.addEventListener('click', () => this.adjustCategorizationSettings('balanced'));
                document.getElementById('permissiveModeBtn')?.addEventListener('click', () => this.adjustCategorizationSettings('permissive'));
                document.getElementById('recategorizeBtn')?.addEventListener('click', () => this.forceRecategorizeAll());

                // Header actions
                document.getElementById('searchToggleBtn')?.addEventListener('click', () => this.toggleSearch());
                document.getElementById('categoriesHeaderBtn')?.addEventListener('click', () => this.toggleCategoryFilter());

                // Search
                document.getElementById('searchCloseBtn')?.addEventListener('click', () => this.toggleSearch());
                document.getElementById('searchInput')?.addEventListener('input', (e) => this.handleSearch(e.target.value));

                // Categories
                document.getElementById('categoryCloseBtn')?.addEventListener('click', () => this.toggleCategoryFilter());

                // Mobile menu
                document.getElementById('mobileMenuBtn')?.addEventListener('click', () => this.toggleMobileMenu());
                document.getElementById('mobileOverlay')?.addEventListener('click', () => this.toggleMobileMenu());

                // Reader
                document.getElementById('closeReader')?.addEventListener('click', () => this.closeReader());

                console.log('✅ Event listeners setup complete');
            }

            checkAuthenticationStatus() {
                console.log('🔐 Checking authentication status...');
                
                // Check for OAuth callback
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');

                if (code) {
                    console.log('🔑 OAuth code found, exchanging for token...');
                    this.exchangeCodeForToken(code, state);
                } else {
                    // Check for stored token
                    const storedToken = localStorage.getItem('onedrive_access_token');
                    if (storedToken) {
                        console.log('💾 Found stored access token');
                        this.accessToken = storedToken;
                        this.updateConnectionStatus(true);
                        this.loadArticles();
                    } else {
                        console.log('❌ No authentication found');
                        this.updateConnectionStatus(false);
                    }
                }
            }

            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                const connectBtn = document.getElementById('connectBtn');
                const refreshBtn = document.getElementById('refreshBtn');

                if (connected) {
                    statusElement.innerHTML = '<span>✅</span><span>Connected to OneDrive</span>';
                    statusElement.className = 'connection-status connected';
                    if (connectBtn) connectBtn.style.display = 'none';
                    if (refreshBtn) refreshBtn.style.display = 'flex';
                } else {
                    statusElement.innerHTML = '<span>🔐</span><span>Ready to Connect</span>';
                    statusElement.className = 'connection-status disconnected';
                    if (connectBtn) connectBtn.style.display = 'flex';
                    if (refreshBtn) refreshBtn.style.display = 'none';
                }
            }

            authenticate() {
                console.log('🔐 Starting authentication...');
                
                // Generate PKCE parameters
                const codeVerifier = this.generateCodeVerifier();
                const codeChallenge = this.generateCodeChallenge(codeVerifier);
                const state = this.generateRandomString(32);

                // Store for later verification
                localStorage.setItem('pkce_code_verifier', codeVerifier);
                localStorage.setItem('oauth_state', state);

                const authUrl = new URL('https://login.microsoftonline.com/common/oauth2/v2.0/authorize');
                authUrl.searchParams.append('client_id', this.clientId);
                authUrl.searchParams.append('response_type', 'code');
                authUrl.searchParams.append('redirect_uri', this.redirectUri);
                authUrl.searchParams.append('scope', 'https://graph.microsoft.com/Files.Read offline_access');
                authUrl.searchParams.append('code_challenge', codeChallenge);
                authUrl.searchParams.append('code_challenge_method', 'S256');
                authUrl.searchParams.append('state', state);

                console.log('🌐 Redirecting to:', authUrl.toString());
                window.location.href = authUrl.toString();
            }

            async exchangeCodeForToken(code, state) {
                try {
                    const storedState = localStorage.getItem('oauth_state');
                    const codeVerifier = localStorage.getItem('pkce_code_verifier');

                    if (state !== storedState) {
                        throw new Error('State mismatch - possible CSRF attack');
                    }

                    const tokenUrl = 'https://login.microsoftonline.com/common/oauth2/v2.0/token';
                    const params = new URLSearchParams({
                        client_id: this.clientId,
                        scope: 'https://graph.microsoft.com/Files.Read offline_access',
                        code: code,
                        redirect_uri: this.redirectUri,
                        grant_type: 'authorization_code',
                        code_verifier: codeVerifier
                    });

                    const response = await fetch(tokenUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params
                    });

                    const data = await response.json();

                    if (data.access_token) {
                        this.accessToken = data.access_token;
                        localStorage.setItem('onedrive_access_token', data.access_token);
                        
                        if (data.refresh_token) {
                            localStorage.setItem('onedrive_refresh_token', data.refresh_token);
                        }

                        this.updateConnectionStatus(true);
                        this.updateStatus('Successfully connected to OneDrive!', 'success');
                        this.loadArticles();

                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        throw new Error(data.error_description || 'Failed to get access token');
                    }

                    // Clean up stored values
                    localStorage.removeItem('oauth_state');
                    localStorage.removeItem('pkce_code_verifier');

                } catch (error) {
                    console.error('❌ Token exchange failed:', error);
                    this.updateStatus(`Authentication failed: ${error.message}`, 'error');
                }
            }

            loadSampleArticles() {
                // Load sample articles for demo with AI categorization
                const sampleArticles = [
                    {
                        id: '1',
                        title: 'Getting Started with React Hooks: A Complete Guide',
                        excerpt: 'Learn how to use React Hooks to manage state and side effects in functional components. This comprehensive guide covers useState, useEffect, and custom hooks.',
                        content: 'React Hooks revolutionized how we write React components by allowing us to use state and lifecycle methods in functional components. useState is the most basic hook that lets you add state to functional components...',
                        domain: 'react.dev',
                        date: '2024-01-15',
                        url: 'https://react.dev/hooks',
                        isRead: false,
                        isFavorite: false,
                        readingTime: 8
                    },
                    {
                        id: '2',
                        title: 'The Future of Artificial Intelligence in 2024',
                        excerpt: 'Exploring the latest developments in AI and machine learning technologies, including GPT models, computer vision, and the impact on various industries.',
                        content: 'Artificial intelligence continues to evolve at breakneck speed. Large language models like GPT-4 have demonstrated remarkable capabilities in natural language processing. Machine learning algorithms are becoming more sophisticated...',
                        domain: 'techcrunch.com',
                        date: '2024-01-14',
                        url: 'https://techcrunch.com/ai-future-2024',
                        isRead: true,
                        isFavorite: true,
                        readingTime: 12
                    },
                    {
                        id: '3',
                        title: 'Sustainable Web Development: Building Green Websites',
                        excerpt: 'How to build environmentally friendly websites and reduce digital carbon footprint through efficient coding practices and optimized performance.',
                        content: 'Web development has an environmental impact through energy consumption. By optimizing our code, reducing bundle sizes, and implementing efficient caching strategies, we can create more sustainable websites...',
                        domain: 'web.dev',
                        date: '2024-01-13',
                        url: 'https://web.dev/sustainable-web',
                        isRead: false,
                        isFavorite: false,
                        readingTime: 6
                    },
                    {
                        id: '4',
                        title: 'Python Data Science: Pandas vs NumPy Performance',
                        excerpt: 'A comprehensive comparison of Pandas and NumPy for data manipulation and analysis, including performance benchmarks and use case recommendations.',
                        content: 'When working with data in Python, choosing between Pandas and NumPy can significantly impact performance. NumPy excels at numerical computations while Pandas provides higher-level data structures...',
                        domain: 'towardsdatascience.com',
                        date: '2024-01-12',
                        url: 'https://towardsdatascience.com/pandas-numpy-comparison',
                        isRead: false,
                        isFavorite: false,
                        readingTime: 10
                    },
                    {
                        id: '5',
                        title: 'Climate Change Policy: Global Summit Results',
                        excerpt: 'Key outcomes from the latest international climate summit, including new carbon reduction commitments and renewable energy initiatives.',
                        content: 'The recent climate summit brought together world leaders to discuss urgent environmental challenges. New policies focus on renewable energy transition, carbon pricing mechanisms, and international cooperation...',
                        domain: 'bbc.com',
                        date: '2024-01-11',
                        url: 'https://bbc.com/climate-summit-2024',
                        isRead: false,
                        isFavorite: false,
                        readingTime: 7
                    },
                    {
                        id: '6',
                        title: 'UX Design Trends 2024: Minimalism and Accessibility',
                        excerpt: 'Explore the latest trends in user experience design, focusing on minimalist interfaces and improved accessibility for all users.',
                        content: 'User experience design continues to evolve with emphasis on accessibility and inclusive design. Minimalist interfaces reduce cognitive load while proper color contrast and keyboard navigation ensure...',
                        domain: 'uxdesign.cc',
                        date: '2024-01-10',
                        url: 'https://uxdesign.cc/trends-2024',
                        isRead: true,
                        isFavorite: false,
                        readingTime: 5
                    }
                ];

                // Apply AI categorization to sample articles
                this.articles = sampleArticles.map(article => {
                    const categoryResult = this.categorizeArticle(article);
                    return {
                        ...article,
                        category: categoryResult?.category || 'Uncategorized',
                        categoryIcon: categoryResult?.icon || '📄',
                        categoryConfidence: categoryResult?.confidence || 0,
                        aiGenerated: true
                    };
                });

                this.updateCategories();
                this.displayArticles();
                this.updateCounts();
            }

            async loadArticles() {
                if (!this.accessToken) {
                    this.updateStatus('Please connect to OneDrive first', 'error');
                    return;
                }

                this.updateStatus('Loading articles from OneDrive...', 'loading');

                try {
                    // This would make actual API calls to OneDrive
                    // For now, we'll use the sample articles with AI categorization
                    setTimeout(() => {
                        this.updateStatus('Articles loaded and categorized successfully!', 'success');
                        this.loadSampleArticles(); // Reload with fresh AI categorization
                    }, 1000);

                } catch (error) {
                    console.error('❌ Failed to load articles:', error);
                    this.updateStatus(`Failed to load articles: ${error.message}`, 'error');
                }
            }

            updateCategories() {
                // Update category counts and dynamic navigation
                this.categories.clear();
                this.articles.forEach(article => {
                    if (article.category && article.category !== 'Uncategorized') {
                        const count = this.categories.get(article.category) || 0;
                        this.categories.set(article.category, count + 1);
                    }
                });

                this.updateCategoryNavigation();
                this.updateCategoryChips();
            }

            updateCategoryNavigation() {
                const container = document.getElementById('dynamicCategoryNav');
                if (!container) return;

                container.innerHTML = '';
                
                // Sort categories by count
                const sortedCategories = Array.from(this.categories.entries())
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 8); // Show top 8 categories

                sortedCategories.forEach(([category, count]) => {
                    const icon = this.categoryKeywords[category]?.icon || '📄';
                    const navItem = document.createElement('button');
                    navItem.className = 'nav-item';
                    navItem.innerHTML = `
                        <span class="icon">${icon}</span>
                        <span class="label">${category}</span>
                        <span class="badge">${count}</span>
                    `;
                    navItem.addEventListener('click', () => this.filterByCategory(category));
                    container.appendChild(navItem);
                });

                // Update category count badge
                document.getElementById('categoryCount').textContent = this.categories.size;
            }

            updateCategoryChips() {
                const container = document.getElementById('categoryChips');
                if (!container) return;

                container.innerHTML = '';

                // Show All button
                const showAllChip = document.createElement('div');
                showAllChip.className = `category-chip show-all ${!this.activeCategory ? 'active' : ''}`;
                showAllChip.innerHTML = `
                    <span>📚</span>
                    <span>Show All</span>
                    <span class="category-count">${this.articles.length}</span>
                `;
                showAllChip.addEventListener('click', () => this.filterByCategory(null));
                container.appendChild(showAllChip);

                // Category chips
                const sortedCategories = Array.from(this.categories.entries())
                    .sort(([,a], [,b]) => b - a);

                sortedCategories.forEach(([category, count]) => {
                    const icon = this.categoryKeywords[category]?.icon || '📄';
                    const chip = document.createElement('div');
                    chip.className = `category-chip ${this.activeCategory === category ? 'active' : ''}`;
                    chip.innerHTML = `
                        <span>${icon}</span>
                        <span>${category}</span>
                        <span class="category-count">${count}</span>
                    `;
                    chip.addEventListener('click', () => this.filterByCategory(category));
                    container.appendChild(chip);
                });
            }

            filterByCategory(category) {
                this.activeCategory = category;
                
                if (category) {
                    const filteredArticles = this.articles.filter(article => article.category === category);
                    this.displayArticles(filteredArticles);
                    document.getElementById('pageTitle').textContent = `${category} Articles`;
                } else {
                    this.displayArticles();
                    document.getElementById('pageTitle').textContent = 'All Articles';
                }

                this.updateCategoryChips();
                this.setActiveNav('categoriesBtn');
            }

            displayArticles(articlesToShow = null) {
                const container = document.getElementById('articlesContainer');
                let articles = articlesToShow || this.articles;

                // Apply search filter if active
                if (this.currentSearchTerm) {
                    articles = articles.filter(article => 
                        article.title.toLowerCase().includes(this.currentSearchTerm.toLowerCase()) ||
                        article.excerpt.toLowerCase().includes(this.currentSearchTerm.toLowerCase()) ||
                        article.category.toLowerCase().includes(this.currentSearchTerm.toLowerCase())
                    );
                }

                if (articles.length === 0) {
                    const emptyMessage = this.currentSearchTerm ? 
                        `No articles found for "${this.currentSearchTerm}"` :
                        'No articles found';
                    
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <h3>${emptyMessage}</h3>
                            <p>Try adjusting your search or category filter.</p>
                        </div>
                    `;
                    return;
                }

                const articlesHTML = articles.map(article => {
                    const categoryClass = this.getCategoryConfidenceClass(article.categoryConfidence);
                    const readingTime = article.readingTime ? `${article.readingTime} min` : '5 min';
                    
                    return `
                        <div class="article-card" data-id="${article.id}">
                            <div class="article-image">
                                ${article.categoryIcon || '📄'}
                                ${article.aiGenerated ? '<div class="cache-indicator metadata">AI</div>' : ''}
                            </div>
                            <div class="article-content">
                                ${article.category !== 'Uncategorized' ? `
                                    <div class="article-category ${categoryClass}">
                                        ${article.categoryIcon} ${article.category}
                                        ${article.categoryConfidence ? `<span style="opacity:0.7">(${article.categoryConfidence}%)</span>` : ''}
                                    </div>
                                ` : ''}
                                <h3 class="article-title">${article.title}</h3>
                                <p class="article-excerpt">${article.excerpt}</p>
                                <div class="article-meta">
                                    <span class="article-domain">${article.domain}</span>
                                    <span class="article-date">${new Date(article.date).toLocaleDateString()}</span>
                                </div>
                                <div class="article-stats">
                                    <span>⏱️ ${readingTime} read</span>
                                    ${article.isRead ? '<span>✅ Read</span>' : '<span>📖 Unread</span>'}
                                    ${article.isFavorite ? '<span>⭐ Favorite</span>' : ''}
                                </div>
                            </div>
                            <div class="article-actions">
                                <button class="action-btn read-btn" title="Read Article" onclick="webReader.openReader('${article.id}')">📖</button>
                                <button class="action-btn export-btn" title="Export Article" onclick="webReader.exportArticle('${article.id}')">📤</button>
                                <button class="action-btn refresh-image-btn" title="Refresh Image" onclick="webReader.refreshImage('${article.id}')">🔄</button>
                                <button class="action-btn delete-btn" title="Delete Article" onclick="webReader.deleteArticle('${article.id}')">🗑️</button>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div class="articles-grid">${articlesHTML}</div>`;

                // Store current displayed articles
                this.currentDisplayedArticles = articles;
            }

            getCategoryConfidenceClass(confidence) {
                if (confidence >= 70) return 'high-confidence';
                if (confidence >= 40) return 'medium-confidence';
                return 'low-confidence';
            }

            openReader(articleId) {
                const article = this.articles.find(a => a.id === articleId);
                if (!article) return;

                // Mark as read
                article.isRead = true;
                this.updateCounts();

                // Populate reader
                document.getElementById('readerTitle').textContent = article.title;
                document.getElementById('readerDate').textContent = new Date(article.date).toLocaleDateString();
                document.getElementById('readerDomain').textContent = article.domain;
                document.getElementById('readerTime').textContent = `${article.readingTime || 5} min read`;
                document.getElementById('readerContent').innerHTML = this.formatArticleContent(article);

                // Setup original link
                document.getElementById('openOriginal').onclick = () => window.open(article.url, '_blank');

                // Show reader
                document.getElementById('readerOverlay').classList.add('active');
                document.body.style.overflow = 'hidden';

                console.log('📖 Opened reader for:', article.title);
            }

            closeReader() {
                document.getElementById('readerOverlay').classList.remove('active');
                document.body.style.overflow = '';
                console.log('📖 Closed reader');
            }

            formatArticleContent(article) {
                // Format content for reader view
                const content = article.content || article.excerpt;
                return `
                    <p><strong>Category:</strong> ${article.categoryIcon} ${article.category} 
                    ${article.categoryConfidence ? `<em>(${article.categoryConfidence}% confidence)</em>` : ''}</p>
                    <p>${content}</p>
                    <blockquote>
                        <p><em>This is a demo article. In a real implementation, the full article content would be fetched from OneDrive or the original URL.</em></p>
                    </blockquote>
                `;
            }

            exportArticle(articleId) {
                const article = this.articles.find(a => a.id === articleId);
                if (!article) return;

                const exportData = {
                    title: article.title,
                    excerpt: article.excerpt,
                    content: article.content,
                    url: article.url,
                    domain: article.domain,
                    date: article.date,
                    category: article.category,
                    categoryConfidence: article.categoryConfidence,
                    readingTime: article.readingTime,
                    exportedAt: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${article.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log('📤 Exported article:', article.title);
            }

            refreshImage(articleId) {
                console.log('🔄 Refreshing image for article:', articleId);
                // In a real implementation, this would refresh the article's image
                this.updateStatus('Image refresh not implemented in demo', 'info');
            }

            deleteArticle(articleId) {
                if (confirm('Are you sure you want to delete this article?')) {
                    this.articles = this.articles.filter(a => a.id !== articleId);
                    this.updateCategories();
                    this.displayArticles();
                    this.updateCounts();
                    console.log('🗑️ Deleted article:', articleId);
                }
            }

            updateCounts() {
                const allCount = this.articles.length;
                const unreadCount = this.articles.filter(a => !a.isRead).length;
                const favoritesCount = this.articles.filter(a => a.isFavorite).length;
                const archiveCount = this.articles.filter(a => a.isArchived).length;

                document.getElementById('allArticleCount').textContent = allCount;
                document.getElementById('unreadCount').textContent = unreadCount;
                document.getElementById('favoritesCount').textContent = favoritesCount;
                document.getElementById('archiveCount').textContent = archiveCount;
            }

            showAllArticles() {
                this.setActiveNav('allArticlesBtn');
                this.activeCategory = null;
                document.getElementById('pageTitle').textContent = 'All Articles';
                this.displayArticles();
                this.updateCategoryChips();
            }

            showUnread() {
                this.setActiveNav('unreadBtn');
                this.activeCategory = null;
                document.getElementById('pageTitle').textContent = 'Unread Articles';
                const unreadArticles = this.articles.filter(a => !a.isRead);
                this.displayArticles(unreadArticles);
                this.updateCategoryChips();
            }

            showFavorites() {
                this.setActiveNav('favoritesBtn');
                this.activeCategory = null;
                document.getElementById('pageTitle').textContent = 'Favorite Articles';
                const favoriteArticles = this.articles.filter(a => a.isFavorite);
                this.displayArticles(favoriteArticles);
                this.updateCategoryChips();
            }

            showArchive() {
                this.setActiveNav('archiveBtn');
                this.activeCategory = null;
                document.getElementById('pageTitle').textContent = 'Archived Articles';
                const archivedArticles = this.articles.filter(a => a.isArchived);
                this.displayArticles(archivedArticles);
                this.updateCategoryChips();
            }

            setActiveNav(activeId) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.getElementById(activeId)?.classList.add('active');
            }

            toggleSearch() {
                this.showSearch = !this.showSearch;
                const container = document.getElementById('searchContainer');
                const input = document.getElementById('searchInput');

                if (this.showSearch) {
                    container.style.display = 'block';
                    setTimeout(() => {
                        container.classList.add('visible');
                        input.focus();
                    }, 10);
                } else {
                    container.classList.remove('visible');
                    setTimeout(() => {
                        container.style.display = 'none';
                    }, 300);
                    this.currentSearchTerm = '';
                    input.value = '';
                    this.displayArticles();
                }
            }

            toggleCategoryFilter() {
                this.showCategories = !this.showCategories;
                const container = document.getElementById('categoryContainer');

                if (this.showCategories) {
                    container.style.display = 'block';
                    setTimeout(() => {
                        container.classList.add('visible');
                    }, 10);
                    this.updateCategoryChips();
                } else {
                    container.classList.remove('visible');
                    setTimeout(() => {
                        container.style.display = 'none';
                    }, 300);
                }
            }

            handleSearch(searchTerm) {
                this.currentSearchTerm = searchTerm.trim();
                this.displayArticles();
                console.log('🔍 Searching for:', searchTerm);
            }

            toggleDarkMode() {
                const isDark = document.body.hasAttribute('data-theme');
                
                if (isDark) {
                    document.body.removeAttribute('data-theme');
                    localStorage.setItem('darkMode', 'false');
                } else {
                    document.body.setAttribute('data-theme', 'dark');
                    localStorage.setItem('darkMode', 'true');
                }

                console.log('🌙 Dark mode:', !isDark ? 'enabled' : 'disabled');
            }

            toggleMobileMenu() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobileOverlay');
                
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            }

            toggleTestMode() {
                document.body.classList.toggle('test-mode');
                const isTestMode = document.body.classList.contains('test-mode');
                console.log('👁️ Test mode:', isTestMode ? 'enabled' : 'disabled');
                this.updateStatus(isTestMode ? 'Test mode enabled - action buttons always visible' : 'Test mode disabled', 'info');
            }

            // AI Categorization Settings
            adjustCategorizationSettings(mode) {
                switch (mode) {
                    case 'strict':
                        this.minCategoryConfidence = 60;
                        this.maxCategories = 10;
                        break;
                    case 'balanced':
                        this.minCategoryConfidence = 35;
                        this.maxCategories = 20;
                        break;
                    case 'permissive':
                        this.minCategoryConfidence = 15;
                        this.maxCategories = 30;
                        break;
                }
                
                console.log(`🤖 AI categorization set to ${mode} mode (confidence: ${this.minCategoryConfidence}%)`);
                this.updateStatus(`AI categorization set to ${mode} mode`, 'success');
                
                // Update active mode indicator
                document.querySelectorAll('#strictModeBtn, #balancedModeBtn, #permissiveModeBtn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`${mode}ModeBtn`)?.classList.add('active');
            }

            forceRecategorizeAll() {
                console.log('🤖 Re-categorizing all articles...');
                this.updateStatus('Re-categorizing articles with AI...', 'loading');
                
                setTimeout(() => {
                    this.articles = this.articles.map(article => {
                        const categoryResult = this.categorizeArticle(article);
                        return {
                            ...article,
                            category: categoryResult?.category || 'Uncategorized',
                            categoryIcon: categoryResult?.icon || '📄',
                            categoryConfidence: categoryResult?.confidence || 0,
                            aiGenerated: true
                        };
                    });
                    
                    this.updateCategories();
                    this.displayArticles();
                    this.updateStatus('All articles re-categorized successfully!', 'success');
                }, 1500);
            }

            // Image and Cache Management
            forceSyncImages() {
                console.log('🔄 Syncing images...');
                this.updateStatus('Syncing images across devices...', 'loading');
                
                setTimeout(() => {
                    this.updateStatus('Image sync completed!', 'success');
                }, 2000);
            }

            retryFailedImages() {
                console.log('🔄 Retrying failed images...');
                this.updateStatus('Retrying failed image downloads...', 'loading');
                
                setTimeout(() => {
                    this.failedImages.clear();
                    this.updateStatus('Failed images retry completed!', 'success');
                }, 1500);
            }

            clearImageCache() {
                if (confirm('Are you sure you want to clear the image cache? This will remove all cached images.')) {
                    localStorage.removeItem(this.cacheKey);
                    this.imageCache.clear();
                    console.log('🗑️ Image cache cleared');
                    this.updateStatus('Image cache cleared successfully!', 'success');
                }
            }

            showImageHelp() {
                const helpText = `
Image Sync Help:

• Images are automatically cached for offline access
• Cache expires after ${this.cacheExpiryDays} days
• Failed images are retried automatically
• Use "Sync Images" to force refresh all images
• Use "Retry Failed" to attempt failed downloads again
• Use "Clear Cache" to remove all cached images

Cache Status:
• Green: Successfully cached
• Blue: Fresh from server
• Orange: Fallback image used
• Purple: AI-generated metadata
• Red: Failed to load

The system automatically optimizes images for faster loading while maintaining quality.
                `;
                
                alert(helpText);
            }

            showEnhancedDebugInfo() {
                const debugInfo = {
                    articlesCount: this.articles.length,
                    categoriesCount: this.categories.size,
                    cacheSize: this.imageCache.size,
                    failedImages: this.failedImages.size,
                    aiSettings: {
                        minConfidence: this.minCategoryConfidence,
                        maxCategories: this.maxCategories,
                        dynamicCategories: this.enableDynamicCategories
                    },
                    currentFilter: this.activeCategory || 'All',
                    searchTerm: this.currentSearchTerm || 'None',
                    authStatus: this.accessToken ? 'Connected' : 'Disconnected',
                    categories: Array.from(this.categories.entries()),
                    lastUpdate: new Date().toISOString()
                };
                
                console.log('🔧 Debug Info:', debugInfo);
                
                const debugText = `
MyPocket AI Reader - Debug Information:

Articles: ${debugInfo.articlesCount}
Categories: ${debugInfo.categoriesCount}
Image Cache: ${debugInfo.cacheSize} items
Failed Images: ${debugInfo.failedImages}

AI Settings:
• Min Confidence: ${debugInfo.aiSettings.minConfidence}%
• Max Categories: ${debugInfo.aiSettings.maxCategories}
• Dynamic Categories: ${debugInfo.aiSettings.dynamicCategories}

Current State:
• Filter: ${debugInfo.currentFilter}
• Search: ${debugInfo.searchTerm}
• Auth: ${debugInfo.authStatus}

Categories:
${debugInfo.categories.map(([cat, count]) => `• ${cat}: ${count}`).join('\n')}

Last Update: ${debugInfo.lastUpdate}
                `;
                
                alert(debugText);
            }

            updateStatus(message, type = 'info') {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;

                if (type === 'loading') {
                    statusElement.innerHTML = `<span class="loading-spinner"></span> ${message}`;
                }

                console.log(`📊 Status: ${message} (${type})`);
                
                // Auto-hide success/info messages after 3 seconds
                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        if (statusElement.textContent === message) {
                            statusElement.textContent = 'Ready';
                            statusElement.className = 'status';
                        }
                    }, 3000);
                }
            }

            // Utility functions for PKCE
            generateRandomString(length) {
                const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += charset.charAt(Math.floor(Math.random() * charset.length));
                }
                return result;
            }

            generateCodeVerifier() {
                return this.generateRandomString(128);
            }

            generateCodeChallenge(verifier) {
                // For demo purposes - in production, use proper SHA256 hashing
                return btoa(verifier).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM loaded, initializing MyPocket Web Reader...');
            window.webReader = new MyPocketWebReader();
        });
    </script>
</body>

</html>
